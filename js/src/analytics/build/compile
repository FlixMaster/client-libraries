#!/bin/bash
# Constructs a minified build of the ReportGrid client library. This uses the
# Google closure compiler and builds both regular and gzipped versions.

# At this point the ReportGrid analytics library requires that jQuery be
# loaded. This may change in the future.

closure_compiler=closure-compiler/compiler.jar

if [[ ! -f $closure_compiler ]]; then
  echo 'This script must be run from inside the build/ directory.'
  exit 1
fi

composite() {
  name=$1
  shift

  echo
  echo $name
  echo

  echo -n "1. assembling uncompressed file; size is "
  cat "$@" > $name-uncompressed.js
  wc -c < $name-uncompressed.js

  echo -n "2. minifying using closure compiler; size is "
  java -jar $closure_compiler --compilation_level SIMPLE_OPTIMIZATIONS \
    --js $name-uncompressed.js \
    --js_output_file $name.js
  wc -c < $name.js

  echo -n "3. gzipping result; size is "
  gzip --best -c $name.js > $name.js.gz
  wc -c < $name.js.gz
}

composite reportgrid-analytics ../reportgrid-analytics.js

composite reportgrid-analytics-onefile ../jquery.1.4-modified.js \
                                       ../../reportgrid-core.js \
                                       ../reportgrid-analytics.js
